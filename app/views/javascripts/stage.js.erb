var ok_sheet
var login_sheet
var sources_sheet

var sources = []

var library_window

if (! ("console" in window) || !("firebug" in console)) {
    var names = ["log", "debug", "info", "warn", "error", "assert", "dir", "dirxml", "group"
                 , "groupEnd", "time", "timeEnd", "count", "trace", "profile", "profileEnd"];
    window.console = {};
    for (var i = 0; i <names.length; ++i) window.console[names[i]] = function() {};
}

var toogle_library_window = function() {
  var width   = 400
  var height  = 300 
  var spacing = 20

  UI.Window.setOptions({
   show: function(el) { el.appear({ duration: 0.2 }) },
   hide: function(el) { el.fade({ duration: 0.2 }) }
  });

  if (library_window == undefined) {    
    library_window = new UI.Window({ 
      parent: 'container',
      theme: "black_hud", 
      resizable: true,
      id: 'library',
      shadow:false,
      height: 400,
      top: 200,
      width: 250, 
      left: 750, 
      superflousEffects: true,  
    }).setContent($('tools').innerHTML).setZIndex(1000).show()
  } else {
    if (library_window.getPosition().top < 0) {
      library_window.setPosition(10, library_window.getPosition().left)
    }
    library_window.visible ? library_window.hide() : library_window.show()    
  }
}



var init_tooltips = function() {
  var options = { 
      effect: 'appear', 
      hideAfter: true, 
      className: 'graphpipes', 
      fixed: true,
      delay: 0.9,
      hook: { target: 'bottomLeft', 
             tip: 'topLeft', 
             offset: {x: 5, y:5}
      }
  }
  
  $$('*[tooltip]').each( function(input) {
     var t = new Tip(input, input.readAttribute('tooltip'), options)
   });

}


var error = function(error) {
  error = error || 'Sorry! This Feature is not implemented yet.'
  $$('div.message h5').each(function(h) {
    h.innerHTML = error
  })
  
  ok_sheet.show()
}

var Patches = []

Event.observe(window, 'dom:loaded', function() {
  
    ok_sheet = new Sheet($("dummy_sheet"))
    login_sheet = new Sheet($("login_sheet"))
    sources_sheet = new Sheet($("sources_sheet"))

    sources = [    
    <% current_user.sources.each_with_index do |s,i| %>
      { name: '<%= s.name %>', iri: '12' }
      <% unless i == current_user.sources.length %> , <% end %>
    <% end %>
    ]    
    
    console.log(sources)
    
   toogle_library_window()
   init_tooltips()
  
  $$('li.test_button').each(function(button) {
    button.observe('click', function() {
      Patches.push(new Patch(button, {id: button.id}))
    })
  })

  
  $('add_rdf_button').observe('click', function(){
     new Ajax.Request('<%= user_sources_path(current_user)%>', {
        asynchronous:true, 
        evalScripts:true, 
        method: 'post',
        parameters:Form.serialize($('sources-form')),
  
        onSuccess: function(transport) {    
          var response = (transport.responseText.evalJSON(true));   
          
          if (!response.success) {
            var header_text = $$('#sources_sheet div.sheet_header h5').first()
            header_text.addClassName('error').innerHTML = response.error_message || 'Ups!'
            return
          } 
          sources.push({name: response.name, iri: response.iri})
          console.log(sources)
          
          sources_sheet.hide(); 
          return false;
        },
        onFailure: function(transport) {
          header_text.addClassName('error').innerHTML = 'Could not connect to server.'    
          console.log('Could not connect to server.')
          sources_sheet.hide(); return false;             
        }
      });       
     return false
   })
  
 jsBox.jsBoxLayer = new WireIt.Layer(window.boxes);
})

